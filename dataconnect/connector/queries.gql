# ------------------------------------------------------------------
# Public Queries - Accessible by anyone, including guests.
# ------------------------------------------------------------------

# Query to search for therapists based on various criteria.
# Used in the Therapist Finder page.
query SearchTherapists(
  $specialty: String
  $location: String
  $minRating: Float
) @auth(level: PUBLIC) {
  therapist(
    where: {
      _and: [
        { specialties: { contains: $specialty } }
        { location: { eq: $location } }
        { averageRating: { ge: $minRating } }
      ]
    }
  ) {
    items {
      id
      user {
        fullName
      }
      profilePictureUrl
      specialties
      location
      averageRating
    }
  }
}

# Query to get the detailed public profile of a single therapist.
# Used when a user clicks on a therapist card.
query GetTherapistDetails($id: UUID!) @auth(level: PUBLIC) {
  therapist(id: $id) {
    id
    user {
      fullName
    }
    profilePictureUrl
    bio
    specialties
    location
    languages
    reviews_on_therapist {
      items {
        rating
        comment
        createdAt
        client {
          fullName
        }
      }
    }
  }
}

# Query to search for available clinic spaces.
query SearchClinicSpaces($location: String, $availableAfter: Timestamp)
  @auth(level: PUBLIC) {
  clinicSpace(
    where: {
      _and: [
        { clinic: { location: { eq: $location } } }
        # This assumes you add an 'availability' field to your ClinicSpace type
        # { availability: { gte: $availableAfter } }
      ]
    }
  ) {
    items {
      id
      name
      imageUrl
      clinic {
        location
      }
      hourlyRate
    }
  }
}

# ------------------------------------------------------------------
# User-Specific Queries - Accessible only by logged-in users.
# ------------------------------------------------------------------

# Query for a logged-in user to get their own profile information.
query GetMyProfile @auth(level: USER) {
  # Uses the UID of the currently authenticated user.
  user(id: { expr: "auth.uid" }) {
    id
    email
    fullName
    role
  }
}

# Query for a client to view their upcoming and past appointments.
query GetMyBookings @auth(level: USER) {
  booking(where: { client: { id: { expr: "auth.uid" } } }) {
    items {
      id
      startTime
      status
      therapist {
        id
        user {
          fullName
        }
      }
      clinicSpace {
        id
        name
      }
    }
  }
}

# ------------------------------------------------------------------
# Role-Specific Queries - For dashboards.
# ------------------------------------------------------------------

# Query for a therapist to get data for their dashboard.
query GetTherapistDashboard @auth(level: USER) {
  therapist(where: { user: { id: { expr: "auth.uid" } } }) {
    items {
      id
      appointments_on_therapist {
        items {
          id
          startTime
          client {
            fullName
          }
        }
      }
    }
  }
}

# Query for a clinic owner to manage their clinics and spaces.
query GetClinicOwnerDashboard @auth(level: USER) {
  clinic(where: { owner: { id: { expr: "auth.uid" } } }) {
    items {
      id
      name
      clinicSpaces_on_clinic {
        items {
          id
          name
          bookings_on_clinicSpace {
            items {
              id
              startTime
              therapist {
                user {
                  fullName
                }
              }
            }
          }
        }
      }
    }
  }
}